<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 14px; white-space: pre-wrap; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>🔍 Worker 接続テスト</h1>
    <p>Worker URL: <strong>https://data-manager-auth.t88596565.workers.dev</strong></p>
    <p>Current Domain: <strong id="currentDomain"></strong></p>
    
    <div>
        <button onclick="testBasicConnection()">🌐 基本接続テスト</button>
        <button onclick="testCORS()">🔗 CORSテスト</button>
        <button onclick="testRegistration()">📝 登録APIテスト</button>
        <button onclick="clearLog()">🗑️ クリア</button>
    </div>
    
    <h3>📝 ログ</h3>
    <div id="log" class="log"></div>
    
    <script>
        const WORKER_URL = 'https://data-manager-auth.t88596565.workers.dev';
        
        function log(type, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            
            let logEntry = `[${timestamp}] ${message}`;
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            logEntry += '\n';
            
            const span = document.createElement('span');
            span.className = type;
            span.textContent = logEntry;
            logDiv.appendChild(span);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testBasicConnection() {
            log('info', '🌐 基本接続テストを開始...');
            
            try {
                const response = await fetch(`${WORKER_URL}/api/auth/init`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer questa-admin-2024',
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    }
                });
                
                log('info', 'Response received', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('success', '✅ 基本接続成功', data);
                } else {
                    const errorText = await response.text();
                    log('error', '❌ 基本接続失敗', { 
                        status: response.status, 
                        error: errorText 
                    });
                }
                
            } catch (error) {
                log('error', '❌ 接続エラー', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
            }
        }
        
        async function testCORS() {
            log('info', '🔗 CORSテストを開始...');
            
            try {
                const response = await fetch(`${WORKER_URL}/api/auth/register`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                log('info', 'CORS preflight response', {
                    status: response.status,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (response.ok) {
                    log('success', '✅ CORS設定OK');
                } else {
                    log('error', '❌ CORS設定に問題があります');
                }
                
            } catch (error) {
                log('error', '❌ CORSテストエラー', {
                    name: error.name,
                    message: error.message
                });
            }
        }
        
        async function testRegistration() {
            log('info', '📝 登録APIテストを開始...');
            
            const testUser = {
                userId: 'test_user_' + Date.now(),
                displayName: 'テストユーザー',
                email: 'test@example.com',
                inquiryNumber: 'DM-2024-' + String(Math.floor(Math.random() * 999999)).padStart(6, '0'),
                registeredAt: new Date().toISOString(),
                status: 'active',
                role: 'user'
            };
            
            log('info', 'Test user data', testUser);
            
            try {
                const response = await fetch(`${WORKER_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify(testUser)
                });
                
                log('info', 'Registration response', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('success', '✅ 登録API成功', data);
                } else {
                    const errorText = await response.text();
                    log('error', '❌ 登録API失敗', { 
                        status: response.status,
                        statusText: response.statusText,
                        error: errorText 
                    });
                    
                    // Try to parse as JSON if possible
                    try {
                        const errorJson = JSON.parse(errorText);
                        log('info', 'Error as JSON', errorJson);
                    } catch (e) {
                        log('info', 'Error is not JSON format');
                    }
                }
                
            } catch (error) {
                log('error', '❌ 登録テストエラー', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            document.getElementById('currentDomain').textContent = window.location.origin;
            log('info', '🚀 Worker接続テスト初期化完了', {
                userAgent: navigator.userAgent,
                origin: window.location.origin,
                workerUrl: WORKER_URL
            });
        });
    </script>
</body>
</html>