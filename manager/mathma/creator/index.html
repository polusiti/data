<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ 問題作成 - 協働作成システム</title>
    <style>
        :root {
            --primary-color: #10b981;
            --secondary-color: #059669;
            --accent-color: #34d399;
            --bg-color: #f0fdf4;
            --text-color: #1f2937;
            --border-color: #bbf7d0;
            --hover-bg: #d1fae5;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --success-color: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 5px solid var(--primary-color);
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .nav-breadcrumb {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .nav-breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
            margin-right: 10px;
        }

        .nav-breadcrumb a:hover {
            text-decoration: underline;
        }

        .form-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .form-section h3 {
            color: var(--primary-color);
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .required {
            color: var(--error-color);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .choices-section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            display: none;
        }

        .choices-section.show {
            display: block;
        }

        .choice-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .choice-item input[type="text"] {
            flex: 1;
        }

        .choice-item input[type="radio"] {
            margin-right: 5px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .validation-message {
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .validation-message.error {
            color: var(--error-color);
        }

        .validation-message.success {
            color: var(--success-color);
        }

        .preview-section {
            background: #f8fafc;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
        }

        .preview-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: left;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: none;
        }

        .preview-content.show {
            display: block;
        }

        .preview-question {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding: 15px;
            background: #f0fdf4;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .preview-choices {
            margin: 15px 0;
        }

        .preview-choice {
            padding: 10px;
            margin: 5px 0;
            background: #f8fafc;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .preview-choice:hover {
            background: var(--hover-bg);
        }

        .preview-choice.correct {
            background: #d1fae5;
            border-left: 3px solid var(--primary-color);
        }

        .approval-info {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .approval-info h4 {
            margin-bottom: 10px;
        }

        .approval-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .approval-step {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .approval-step-number {
            background: white;
            color: var(--primary-color);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .approval-steps {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-breadcrumb">
            <a href="../">🔢 Math Manager</a> → <span>✨ 問題作成</span>
        </div>

        <div class="header">
            <h1>✨ 問題作成</h1>
            <p>協働問題作成システム - 簡潔で効率的</p>
        </div>

        <div class="approval-info">
            <h4>📋 協働作成・承認システム</h4>
            <p>作成された問題は3人以上の承認を経て公開されます。高品質な問題作成にご協力ください。</p>
            <div class="approval-steps">
                <div class="approval-step">
                    <div class="approval-step-number">1</div>
                    <p>問題作成</p>
                </div>
                <div class="approval-step">
                    <div class="approval-step-number">2</div>
                    <p>内容確認</p>
                </div>
                <div class="approval-step">
                    <div class="approval-step-number">3</div>
                    <p>承認待ち</p>
                </div>
                <div class="approval-step">
                    <div class="approval-step-number">4</div>
                    <p>公開</p>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>📝 基本情報</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="questionType">問題形式 <span class="required">*</span></label>
                    <select id="questionType" required>
                        <option value="">選択してください</option>
                        <option value="A1">A1択 (4-5択選択問題)</option>
                        <option value="F1">F1自由 (短答・数値入力)</option>
                        <option value="F2">F2記述 (完全記述・証明)</option>
                    </select>
                    <div class="validation-message" id="typeValidation"></div>
                </div>
                <div class="form-group">
                    <label for="difficulty">難易度 <span class="required">*</span></label>
                    <select id="difficulty" required>
                        <option value="">選択してください</option>
                        <option value="易">易 (基礎レベル)</option>
                        <option value="中">中 (標準レベル)</option>
                        <option value="難">難 (発展レベル)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="category">カテゴリ <span class="required">*</span></label>
                    <select id="category" required>
                        <option value="">選択してください</option>
                        <option value="代数">代数 (方程式・不等式)</option>
                        <option value="関数">関数 (2次関数・指数対数)</option>
                        <option value="図形">図形 (三角比・座標)</option>
                        <option value="微分">微分 (導関数・極限)</option>
                        <option value="積分">積分 (定積分・応用)</option>
                        <option value="確率">確率 (場合の数・統計)</option>
                        <option value="数列">数列 (等差・等比・漸化式)</option>
                        <option value="ベクトル">ベクトル (平面・空間)</option>
                        <option value="三角関数">三角関数 (加法定理・グラフ)</option>
                        <option value="その他">その他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="customCategory">カスタムカテゴリ</label>
                    <input type="text" id="customCategory" placeholder="「その他」選択時に入力">
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>📋 問題内容</h3>
            <div class="form-group">
                <label for="title">問題タイトル <span class="required">*</span></label>
                <input type="text" id="title" placeholder="例: 二次方程式の解" required>
                <div class="validation-message" id="titleValidation"></div>
            </div>
            <div class="form-group">
                <label for="question">問題文 <span class="required">*</span></label>
                <textarea id="question" placeholder="問題文を入力してください。数式も記述可能です。" rows="4" required></textarea>
                <div class="validation-message" id="questionValidation"></div>
            </div>
            
            <!-- A1択選択肢セクション -->
            <div class="choices-section" id="choicesSection">
                <h4>選択肢設定</h4>
                <div id="choicesList">
                    <div class="choice-item">
                        <input type="radio" name="correctChoice" value="0">
                        <span>1.</span>
                        <input type="text" class="choice-text" placeholder="選択肢1">
                    </div>
                    <div class="choice-item">
                        <input type="radio" name="correctChoice" value="1">
                        <span>2.</span>
                        <input type="text" class="choice-text" placeholder="選択肢2">
                    </div>
                    <div class="choice-item">
                        <input type="radio" name="correctChoice" value="2">
                        <span>3.</span>
                        <input type="text" class="choice-text" placeholder="選択肢3">
                    </div>
                    <div class="choice-item">
                        <input type="radio" name="correctChoice" value="3">
                        <span>4.</span>
                        <input type="text" class="choice-text" placeholder="選択肢4">
                    </div>
                </div>
                <button type="button" class="btn btn-secondary btn-small" onclick="addChoice()">+ 選択肢追加</button>
                <div class="validation-message" id="choicesValidation"></div>
            </div>

            <!-- F1/F2解答セクション -->
            <div class="form-group" id="answerSection" style="display: none;">
                <label for="answer">解答 <span class="required">*</span></label>
                <textarea id="answer" placeholder="F1: 数値や簡潔な答え&#10;F2: 詳細な証明や解答過程" rows="3"></textarea>
                <div class="validation-message" id="answerValidation"></div>
            </div>

            <div class="form-group">
                <label for="explanation">解説</label>
                <textarea id="explanation" placeholder="解答の解説や考え方を記述してください" rows="3"></textarea>
            </div>
        </div>

        <div class="form-section">
            <h3>🔍 プレビュー</h3>
            <div class="preview-section">
                <div id="previewPlaceholder">
                    <p style="color: #6b7280;">問題内容を入力すると、ここにプレビューが表示されます</p>
                    <button class="btn btn-secondary btn-small" onclick="updatePreview()">プレビュー更新</button>
                </div>
                <div class="preview-content" id="previewContent">
                    <!-- プレビューコンテンツ -->
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>💾 保存・送信</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                <button class="btn btn-secondary" onclick="saveDraft()">📝 下書き保存</button>
                <button class="btn btn-warning" onclick="validateAndPreview()">🔍 最終確認</button>
                <button class="btn btn-primary" onclick="submitQuestion()">📤 承認申請</button>
                <button class="btn btn-secondary" onclick="resetForm()">🔄 リセット</button>
            </div>
        </div>
    </div>

    <script>
        // 問題作成システム
        class QuestionCreator {
            constructor() {
                this.currentQuestion = {};
                this.choiceCount = 4;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadDraft();
            }

            setupEventListeners() {
                // 問題形式変更時の表示切り替え
                document.getElementById('questionType').addEventListener('change', (e) => {
                    this.toggleSections(e.target.value);
                });

                // カテゴリ変更時のカスタムカテゴリ表示
                document.getElementById('category').addEventListener('change', (e) => {
                    const customCategory = document.getElementById('customCategory');
                    customCategory.style.display = e.target.value === 'その他' ? 'block' : 'none';
                });

                // リアルタイム入力バリデーション
                ['title', 'question', 'answer'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', () => this.validateField(id));
                    }
                });

                // 自動プレビュー更新
                ['title', 'question', 'answer'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', () => {
                            clearTimeout(this.previewTimeout);
                            this.previewTimeout = setTimeout(() => this.updatePreview(), 1000);
                        });
                    }
                });
            }

            toggleSections(type) {
                const choicesSection = document.getElementById('choicesSection');
                const answerSection = document.getElementById('answerSection');

                if (type === 'A1') {
                    choicesSection.classList.add('show');
                    answerSection.style.display = 'none';
                } else if (type === 'F1' || type === 'F2') {
                    choicesSection.classList.remove('show');
                    answerSection.style.display = 'block';
                } else {
                    choicesSection.classList.remove('show');
                    answerSection.style.display = 'none';
                }

                this.updatePreview();
            }

            addChoice() {
                if (this.choiceCount >= 6) {
                    alert('選択肢は最大6個まで追加可能です。');
                    return;
                }

                this.choiceCount++;
                const choicesList = document.getElementById('choicesList');
                const newChoice = document.createElement('div');
                newChoice.className = 'choice-item';
                newChoice.innerHTML = `
                    <input type="radio" name="correctChoice" value="${this.choiceCount - 1}">
                    <span>${this.choiceCount}.</span>
                    <input type="text" class="choice-text" placeholder="選択肢${this.choiceCount}">
                    <button type="button" class="btn btn-secondary btn-small" onclick="this.parentElement.remove()">削除</button>
                `;
                choicesList.appendChild(newChoice);
            }

            validateField(fieldId) {
                const field = document.getElementById(fieldId);
                const validation = document.getElementById(fieldId + 'Validation');
                
                if (!validation) return;

                if (field.value.trim() === '') {
                    validation.textContent = '必須項目です';
                    validation.className = 'validation-message error';
                    return false;
                } else {
                    validation.textContent = '✓';
                    validation.className = 'validation-message success';
                    return true;
                }
            }

            validateForm() {
                let isValid = true;
                const requiredFields = ['questionType', 'difficulty', 'category', 'title', 'question'];

                requiredFields.forEach(fieldId => {
                    if (!this.validateField(fieldId)) {
                        isValid = false;
                    }
                });

                // 問題形式別の追加バリデーション
                const questionType = document.getElementById('questionType').value;
                if (questionType === 'A1') {
                    const choices = Array.from(document.querySelectorAll('.choice-text')).map(input => input.value.trim());
                    const correctChoice = document.querySelector('input[name="correctChoice"]:checked');
                    
                    if (choices.filter(choice => choice !== '').length < 2) {
                        document.getElementById('choicesValidation').textContent = '選択肢を最低2つ入力してください';
                        document.getElementById('choicesValidation').className = 'validation-message error';
                        isValid = false;
                    } else if (!correctChoice) {
                        document.getElementById('choicesValidation').textContent = '正解を選択してください';
                        document.getElementById('choicesValidation').className = 'validation-message error';
                        isValid = false;
                    } else {
                        document.getElementById('choicesValidation').textContent = '✓';
                        document.getElementById('choicesValidation').className = 'validation-message success';
                    }
                } else if (questionType === 'F1' || questionType === 'F2') {
                    if (!this.validateField('answer')) {
                        isValid = false;
                    }
                }

                return isValid;
            }

            updatePreview() {
                const previewPlaceholder = document.getElementById('previewPlaceholder');
                const previewContent = document.getElementById('previewContent');
                
                const title = document.getElementById('title').value.trim();
                const question = document.getElementById('question').value.trim();
                const questionType = document.getElementById('questionType').value;

                if (!title || !question || !questionType) {
                    previewPlaceholder.style.display = 'block';
                    previewContent.classList.remove('show');
                    return;
                }

                previewPlaceholder.style.display = 'none';
                previewContent.classList.add('show');

                let previewHTML = `
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">${title}</h4>
                    <div class="preview-question">${question}</div>
                `;

                if (questionType === 'A1') {
                    const choices = Array.from(document.querySelectorAll('.choice-text')).map((input, index) => ({
                        text: input.value.trim(),
                        index: index
                    })).filter(choice => choice.text !== '');

                    const correctChoice = document.querySelector('input[name="correctChoice"]:checked');
                    const correctIndex = correctChoice ? parseInt(correctChoice.value) : -1;

                    if (choices.length > 0) {
                        previewHTML += '<div class="preview-choices">';
                        choices.forEach((choice, index) => {
                            const isCorrect = choice.index === correctIndex;
                            previewHTML += `
                                <div class="preview-choice ${isCorrect ? 'correct' : ''}">
                                    ${index + 1}. ${choice.text}
                                    ${isCorrect ? ' ✓' : ''}
                                </div>
                            `;
                        });
                        previewHTML += '</div>';
                    }
                } else if (questionType === 'F1' || questionType === 'F2') {
                    const answer = document.getElementById('answer').value.trim();
                    if (answer) {
                        previewHTML += `
                            <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <strong>解答:</strong> ${answer}
                            </div>
                        `;
                    }
                }

                const explanation = document.getElementById('explanation').value.trim();
                if (explanation) {
                    previewHTML += `
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <strong>解説:</strong> ${explanation}
                        </div>
                    `;
                }

                previewContent.innerHTML = previewHTML;
            }

            generateQuestionId() {
                const timestamp = Date.now().toString(36);
                const random = Math.random().toString(36).substr(2, 5);
                return `math_${timestamp}_${random}`;
            }

            buildQuestionData() {
                const questionType = document.getElementById('questionType').value;
                const data = {
                    id: this.generateQuestionId(),
                    type: questionType,
                    title: document.getElementById('title').value.trim(),
                    question: document.getElementById('question').value.trim(),
                    difficulty: document.getElementById('difficulty').value,
                    category: document.getElementById('category').value === 'その他' ? 
                             document.getElementById('customCategory').value.trim() : 
                             document.getElementById('category').value,
                    explanation: document.getElementById('explanation').value.trim(),
                    created: new Date().toISOString(),
                    approvals: 0,
                    rating: 0,
                    status: 'draft'
                };

                if (questionType === 'A1') {
                    const choices = Array.from(document.querySelectorAll('.choice-text'))
                                         .map(input => input.value.trim())
                                         .filter(choice => choice !== '');
                    const correctChoice = document.querySelector('input[name="correctChoice"]:checked');
                    
                    data.choices = choices;
                    data.correct = correctChoice ? parseInt(correctChoice.value) : 0;
                } else if (questionType === 'F1' || questionType === 'F2') {
                    data.answer = document.getElementById('answer').value.trim();
                }

                return data;
            }

            saveDraft() {
                if (!document.getElementById('title').value.trim()) {
                    alert('タイトルを入力してください。');
                    return;
                }

                const questionData = this.buildQuestionData();
                questionData.status = 'draft';
                
                localStorage.setItem('questionDraft', JSON.stringify(questionData));
                alert('📝 下書きを保存しました！');
            }

            loadDraft() {
                const draft = localStorage.getItem('questionDraft');
                if (!draft) return;

                const data = JSON.parse(draft);
                
                // フォームに値を設定
                Object.keys(data).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = data[key];
                    }
                });

                // 問題形式に応じた表示切り替え
                this.toggleSections(data.type);
                
                // A1択の場合、選択肢を復元
                if (data.type === 'A1' && data.choices) {
                    const choiceInputs = document.querySelectorAll('.choice-text');
                    data.choices.forEach((choice, index) => {
                        if (choiceInputs[index]) {
                            choiceInputs[index].value = choice;
                        }
                    });
                    
                    if (data.correct !== undefined) {
                        const correctRadio = document.querySelector(`input[name="correctChoice"][value="${data.correct}"]`);
                        if (correctRadio) correctRadio.checked = true;
                    }
                }

                this.updatePreview();
            }

            validateAndPreview() {
                if (!this.validateForm()) {
                    alert('❌ 入力内容に不備があります。赤色の項目を確認してください。');
                    return;
                }

                this.updatePreview();
                
                // プレビューセクションにスクロール
                document.querySelector('.preview-section').scrollIntoView({ 
                    behavior: 'smooth' 
                });

                alert('✅ 入力内容を確認してください。問題なければ「承認申請」をクリックしてください。');
            }

            submitQuestion() {
                if (!this.validateForm()) {
                    alert('❌ 入力内容に不備があります。「最終確認」で内容を確認してください。');
                    return;
                }

                const questionData = this.buildQuestionData();
                questionData.status = 'pending';

                // 既存の問題データを取得
                const existingQuestions = JSON.parse(localStorage.getItem('mathQuestions') || '[]');
                existingQuestions.push(questionData);
                
                // 保存
                localStorage.setItem('mathQuestions', JSON.stringify(existingQuestions));
                
                // 下書きを削除
                localStorage.removeItem('questionDraft');

                alert('✅ 問題を承認申請しました！承認されると問題一覧に表示されます。');
                
                // フォームをリセット
                this.resetForm();
            }

            resetForm() {
                if (confirm('入力内容をすべてクリアしてもよろしいですか？')) {
                    document.querySelectorAll('input, select, textarea').forEach(element => {
                        if (element.type === 'radio' || element.type === 'checkbox') {
                            element.checked = false;
                        } else {
                            element.value = '';
                        }
                    });
                    
                    this.toggleSections('');
                    this.updatePreview();
                    
                    // バリデーションメッセージをクリア
                    document.querySelectorAll('.validation-message').forEach(msg => {
                        msg.textContent = '';
                        msg.className = 'validation-message';
                    });
                }
            }
        }

        // グローバル関数
        function addChoice() {
            window.questionCreator.addChoice();
        }

        function updatePreview() {
            window.questionCreator.updatePreview();
        }

        function saveDraft() {
            window.questionCreator.saveDraft();
        }

        function validateAndPreview() {
            window.questionCreator.validateAndPreview();
        }

        function submitQuestion() {
            window.questionCreator.submitQuestion();
        }

        function resetForm() {
            window.questionCreator.resetForm();
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            window.questionCreator = new QuestionCreator();
        });
    </script>
</body>
</html>