<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>LaTeX 正規化デモ（KaTeX プレビュー）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="../assets/js/answer-normalizer.js"></script>
  <style>
    :root{ --fg:#0f172a; --muted:#475569; --err:#b91c1c; --ok:#166534; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--fg); padding:16px; }
    input[type="text"]{ width:100%; max-width:760px; padding:.55rem .7rem; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:15px; }
    select{ padding:.35rem .5rem; }
    .kbd{ display:flex; flex-wrap:wrap; gap:.35rem; margin:.6rem 0; }
    .kbd button{ padding:.28rem .5rem; border:1px solid #cbd5e1; border-radius:8px; background:#fff; cursor:pointer; font-family:ui-monospace,Menlo,Consolas,monospace; }
    .label{ font-size:.85rem; color:var(--muted); }
    .box{ padding:.6rem .8rem; border:1px solid #e2e8f0; border-radius:12px; background:#fff; margin-top:.6rem; }
    .preview{ font-size:1.35rem; min-height:2.2rem; }
    .err{ color:var(--err); margin-top:.35rem; }
    .warn{ color:#a16207; margin-top:.25rem; }
    .ok{ color:var(--ok); margin-top:.35rem; font-family:ui-monospace,Menlo,Consolas,monospace; }
    .chips{ display:flex; flex-wrap:wrap; gap:.35rem; margin:.5rem 0; }
    .chip{ padding:.25rem .5rem; border:1px solid #cbd5e1; border-radius:999px; cursor:pointer; background:#f8fafc; font-family:ui-monospace,Menlo,Consolas,monospace; }
  </style>
</head>
<body>
  <h1>LaTeX 正規化デモ</h1>
  <p class="label">LaTeX 記法をそのまま KaTeX に渡してプレビューします（入力欄では \ は1個）。</p>

  <label>問題タイプ:
    <select id="mode">
      <option value="generic">generic（通常）</option>
      <option value="line">line（直線）</option>
      <option value="ratio">ratio（比）</option>
      <option value="vector">vector（ベクトル）</option>
      <option value="congruence">congruence（合同式）</option>
    </select>
  </label>

  <div class="kbd">
    <button data-ins="\frac{ }{ }">\frac{ }{ }</button>
    <button data-ins="\sqrt{ }">\sqrt{ }</button>
    <button data-ins="\vec{ }">\vec{ }</button>
    <button data-ins="\binom{ }{ }">\binom{ }{ }</button>
    <button data-ins="{}_{n}\mathrm{P}_{k}">{}_{n}\mathrm{P}_{k}</button>
    <button data-ins="\ge">\ge</button>
    <button data-ins="\le">\le</button>
    <button data-ins="\{  \}">\{  \}</button>
    <button data-ins="\pi">\pi</button>
    <button data-ins="^{\circ}">^{\circ}</button>
    <button data-ins="(">(</button>
    <button data-ins=")">)</button>
    <button data-ins="*">*</button>
    <button data-ins=":">:</button>
  </div>

  <input id="ans" type="text" autocomplete="off" autocapitalize="off" spellcheck="false"
    placeholder="例: \frac{4+\sqrt{2}}{3}, \binom{n}{k}, \cos(30^{\circ})=\frac{\sqrt{3}}{2}, 7=1(mod 3), \vec{b}-\frac{1}{3}\vec{a}">

  <div class="chips">
    <span class="chip" data-sample="\{1,2\}">集合: \{1,2\}</span>
    <span class="chip" data-sample="\frac{\{1,2\}}{3}">分子が集合: \frac{\{1,2\}}{3}</span>
    <span class="chip" data-sample="\frac{4+\sqrt{2}}{3}">分数+根: \frac{4+\sqrt{2}}{3}</span>
    <span class="chip" data-sample="\binom{n}{k}">組合せ: \binom{n}{k}</span>
    <span class="chip" data-sample="7=1(mod3)">合同: 7=1(mod3)</span>
    <span class="chip" data-sample="\cos(30^{\circ})=\frac{\sqrt{3}}{2}">度・三角: \cos(30^{\circ})=\frac{\sqrt{3}}{2}</span>
    <span class="chip" data-sample="2:4">比: 2:4</span>
    <span class="chip" data-sample="\vec{b}-\frac{1}{3}\vec{a}">ベクトル: \vec{b}-\frac{1}{3}\vec{a}</span>
  </div>

  <div class="box">
    <div class="label">正規化（採点用比較文字列）</div>
    <div id="norm" class="ok"></div>
  </div>

  <div class="box">
    <div class="label">プレビュー（KaTeX）</div>
    <div id="prev" class="preview"></div>
    <div id="err" class="err"></div>
    <div id="warn" class="warn"></div>
  </div>

  <script>
    const ans  = document.getElementById('ans');
    const mode = document.getElementById('mode');
    const prev = document.getElementById('prev');
    const norm = document.getElementById('norm');
    const err  = document.getElementById('err');
    const warn = document.getElementById('warn');

    function render(){
      const r = window.AnswerNormalizer.normalizeAnswer(ans.value, mode.value);
      norm.textContent = r.normalized || '(空)';
      warn.textContent = r.warnings?.[0] || '';
      if(r.errors.length){
        err.textContent = r.errors[0];
        prev.textContent = '';
        return;
      }
      err.textContent = '';
      if(window.katex){
        katex.render(r.katex, prev, {throwOnError:false});
      }else{
        prev.textContent = r.katex;
      }
    }
    ans.addEventListener('input', render);
    mode.addEventListener('change', render);

    document.querySelectorAll('.kbd button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        insertText(ans, btn.getAttribute('data-ins'));
        ans.focus();
        render();
      });
    });
    document.querySelectorAll('.chip').forEach(chip=>{
      chip.addEventListener('click', ()=>{
        ans.value = chip.getAttribute('data-sample');
        render();
      });
    });

    function insertText(input, text){
      const start = input.selectionStart||0, end = input.selectionEnd||0;
      input.setRangeText(text, start, end, 'end');
    }

    // 初期描画（KaTeXロード後でもOK）
    document.addEventListener('DOMContentLoaded', render);
    window.addEventListener('load', render);
  </script>
</body>
</html>
