{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Advanced Quiz Question",
  "type": "object",
  "required": ["id", "answerFormat", "subject", "topic", "difficulty", "questionContent", "answerData", "explanation", "active"],
  "properties": {
    "id": { 
      "type": "string", 
      "pattern": "^[a-z0-9\\-]+$",
      "description": "問題の一意識別子"
    },
    "answerFormat": { 
      "type": "string", 
      "enum": ["A1", "A2", "A3", "F1", "F2", "ESSAY"],
      "description": "解答形式 (A1:4択, A2:6択, A3:9択, F1:分数, F2:自由入力, ESSAY:記述式)"
    },
    "subject": { 
      "type": "string",
      "description": "科目"
    },
    "topic": { 
      "type": "string",
      "description": "分野"
    },
    "difficulty": { 
      "type": "integer", 
      "minimum": 1, 
      "maximum": 5,
      "description": "難易度"
    },
    "tags": { 
      "type": "array", 
      "items": {"type": "string"},
      "description": "タグ配列"
    },
    "questionContent": {
      "type": "object",
      "required": ["text"],
      "properties": {
        "stem": { 
          "type": "string",
          "description": "問題の指示文"
        },
        "text": { 
          "type": "string",
          "description": "問題文（LaTeX対応）"
        },
        "latex": { 
          "type": "boolean",
          "default": false,
          "description": "LaTeX記法を含むかどうか"
        },
        "images": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "url": {"type": "string"},
              "alt": {"type": "string"},
              "position": {"type": "string", "enum": ["before", "after", "inline"]},
              "caption": {"type": "string"}
            },
            "required": ["url", "alt"]
          },
          "description": "問題に関連する画像"
        },
        "diagrams": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": {"type": "string", "enum": ["graph", "chart", "geometry", "circuit"]},
              "data": {"type": "object"},
              "config": {"type": "object"}
            }
          },
          "description": "動的図表データ"
        }
      },
      "description": "問題内容の詳細"
    },
    "answerData": {
      "type": "object",
      "description": "解答データ",
      "oneOf": [
        {
          "properties": {
            "type": {"const": "multiple-choice"},
            "choices": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "text": {"type": "string"},
                  "latex": {"type": "boolean", "default": false},
                  "isCorrect": {"type": "boolean"},
                  "isClose": {"type": "boolean", "default": false, "description": "惜しい解答かどうか"},
                  "feedback": {"type": "string", "description": "この選択肢に対するフィードバック"}
                },
                "required": ["text", "isCorrect"]
              }
            },
            "correctAnswers": {
              "type": "array",
              "items": {"type": "integer"},
              "description": "正解の選択肢インデックス配列"
            },
            "closeAnswers": {
              "type": "array",
              "items": {"type": "integer"},
              "description": "惜しい解答の選択肢インデックス配列"
            },
            "allowMultiple": {"type": "boolean", "default": false}
          },
          "required": ["type", "choices", "correctAnswers"]
        },
        {
          "properties": {
            "type": {"const": "fraction"},
            "expectedAnswer": {
              "type": "object",
              "required": ["a", "b", "c"],
              "properties": {
                "a": {"type": "integer"},
                "b": {"type": "integer", "minimum": 0},
                "c": {"type": "integer", "not": {"const": 0}}
              }
            },
            "alternativeAnswers": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "a": {"type": "integer"},
                  "b": {"type": "integer"},
                  "c": {"type": "integer"},
                  "isClose": {"type": "boolean", "default": false}
                }
              },
              "description": "代替可能な正解・惜しい解答"
            },
            "limits": {
              "type": "object",
              "properties": {
                "a": {"type": "object", "properties": {"min": {"type": "integer"}, "max": {"type": "integer"}}},
                "b": {"type": "object", "properties": {"min": {"type": "integer"}, "max": {"type": "integer"}}},
                "c": {"type": "object", "properties": {"min": {"type": "integer"}, "max": {"type": "integer"}}}
              }
            }
          },
          "required": ["type", "expectedAnswer"]
        },
        {
          "properties": {
            "type": {"const": "free-text"},
            "expectedAnswers": {
              "type": "array",
              "items": {"type": "string"},
              "description": "正解パターン配列"
            },
            "closeAnswers": {
              "type": "array",
              "items": {"type": "string"},
              "description": "惜しい解答パターン配列"
            },
            "validation": {
              "type": "object",
              "properties": {
                "caseSensitive": {"type": "boolean", "default": false},
                "normalizeWhitespace": {"type": "boolean", "default": true},
                "patterns": {
                  "type": "array",
                  "items": {"type": "string"},
                  "description": "正規表現パターン配列"
                }
              }
            }
          },
          "required": ["type", "expectedAnswers"]
        },
        {
          "properties": {
            "type": {"const": "essay"},
            "evaluationCriteria": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "criterion": {"type": "string"},
                  "description": {"type": "string"},
                  "maxPoints": {"type": "integer"},
                  "rubric": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "level": {"type": "string"},
                        "points": {"type": "integer"},
                        "description": {"type": "string"}
                      }
                    }
                  }
                }
              }
            },
            "sampleAnswer": {"type": "string", "description": "模範解答例"},
            "keyWords": {
              "type": "array",
              "items": {"type": "string"},
              "description": "解答に含まれるべきキーワード"
            }
          },
          "required": ["type", "evaluationCriteria"]
        }
      ]
    },
    "explanation": {
      "type": "object",
      "required": ["text"],
      "properties": {
        "text": {"type": "string", "description": "基本解説"},
        "latex": {"type": "boolean", "default": false},
        "detailed": {"type": "string", "description": "詳細解説"},
        "steps": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "step": {"type": "integer"},
              "title": {"type": "string"},
              "content": {"type": "string"},
              "latex": {"type": "boolean", "default": false}
            }
          },
          "description": "ステップバイステップ解説"
        },
        "hints": {
          "type": "array",
          "items": {"type": "string"},
          "description": "ヒント配列"
        },
        "relatedConcepts": {
          "type": "array",
          "items": {"type": "string"},
          "description": "関連概念"
        },
        "images": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "url": {"type": "string"},
              "alt": {"type": "string"},
              "caption": {"type": "string"}
            }
          }
        }
      },
      "description": "詳細な解説データ"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "createdAt": {"type": "string", "format": "date-time"},
        "updatedAt": {"type": "string", "format": "date-time"},
        "createdBy": {"type": "string"},
        "version": {"type": "string"},
        "sourceBook": {"type": "string", "description": "出典書籍"},
        "pageNumber": {"type": "integer", "description": "出典ページ"},
        "estimatedTime": {"type": "integer", "description": "想定解答時間（秒）"},
        "actualDifficulty": {"type": "number", "description": "実際の正答率から算出した難易度"}
      }
    },
    "active": { 
      "type": "boolean",
      "description": "問題の有効/無効"
    }
  }
}