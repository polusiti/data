# コストシミュレーション

## シナリオ別コスト分析

### シナリオ1: 小規模サービス（月間1,000ユーザー登録）
- ユーザー登録: 1,000通
- パスワードリセット: 100通
- 通知メール: 200通
- **合計: 1,300通/月**

#### 各サービスの場合
- **Resend**: 無料（3,000通枠内）
- **SendGrid**: 無料（3,100通枠内）
- **AWS SES**: 無料（62,000通枠内）
- **ハイブリッド**: 無料（Resendで対応）

### シナリオ2: 中規模サービス（月間5,000ユーザー登録）
- ユーザー登録: 5,000通
- パスワードリセット: 500通
- 通知メール: 1,000通
- **合計: 6,500通/月**

#### 各サービスの場合
- **Resend**: $8.00（3,000無料 + 3,500有料 × $0.002）
- **SendGrid**: $19.95（月額固定プラン）
- **AWS SES**: 無料（62,000通枠内）
- **ハイブリッド**: $7.00（Resend 3,000無料 + SES 3,500無料）

### シナリオ3: 大規模サービス（月間10,000ユーザー登録）
- ユーザー登録: 10,000通
- パスワードリセット: 1,000通
- 通知メール: 2,000通
- **合計: 13,000通/月**

#### 各サービスの場合
- **Resend**: $20.00（3,000無料 + 10,000有料 × $0.002）
- **SendGrid**: $19.95（月額固定プラン）
- **AWS SES**: 無料（62,000通枠内）
- **ハイブリッド**: $20.00（SESで全て無料）

### シナリオ4: 超大規模サービス（月間100,000ユーザー登録）
- ユーザー登録: 100,000通
- パスワードリセット: 10,000通
- 通知メール: 20,000通
- **合計: 130,000通/月**

#### 各サービスの場合
- **Resend**: $254.00（3,000無料 + 127,000有料 × $0.002）
- **SendGrid**: $99.95（100,000通プラン）
- **AWS SES**: $6.80（62,000無料 + 68,000有料 × $0.0001）
- **ハイブリッド**: $6.80（SESで最適化）

## 節約効果分析

### ハイブリッド戦略の節約効果

| ユーザー規模 | SendGrid単体 | ハイブリッド戦略 | 節約額 |
|------------|-------------|-----------------|--------|
| 1,000/月   | $19.95      | $0              | $19.95 |
| 5,000/月   | $19.95      | $0              | $19.95 |
| 10,000/月  | $19.95      | $0              | $19.95 |
| 100,000/月 | $99.95      | $6.80           | $93.15 |

### 無料枠最大活用戦略

```
月間 65,000通まで完全無料:
- Resend: 3,000通
- SendGrid: 3,100通 (100通/日)
- AWS SES: 62,000通
- 合計: 68,100通/月まで無料枠
```

## 実装推奨プラン

### Phase 1: スタートアップ（0-3,000通/月）
```
サービス: Resendのみ
コスト: $0/月
設定: RESEND_API_KEYのみ
```

### Phase 2: 成長期（3,001-65,000通/月）
```
サービス: Resend + AWS SES
コスト: $0/月
設定: ハイブリッドルーター
```

### Phase 3: 大規模（65,001通/月〜）
```
サービス: AWS SESメイン + SendGridフォールバック
コスト: $0.0001/通
設定: コストベースルーティング
```

## 監視と自動化

### 使用量監視
```javascript
// 月間使用量チェック
async function checkMonthlyUsage(env) {
  const usage = await getMonthlyUsage(env);
  const total = usage.resend + usage.sendgrid + usage.ses;
  
  if (total > 60000) {
    // 警告メール送信
    await sendAdminNotification('メール使用量が60,000通を超えました');
  }
}
```

### 自動フェイルオーバー
```javascript
// サービス障害時の自動切り替え
async function sendWithFailover(email, code) {
  const services = ['resend', 'sendgrid', 'ses'];
  
  for (const service of services) {
    try {
      const result = await this[`sendVia${service}`](email, code);
      if (result.success) return result;
    } catch (error) {
      console.log(`${service} failed, trying next...`);
    }
  }
  
  throw new Error('All email services failed');
}
```