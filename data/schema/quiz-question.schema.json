{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Quiz Test Question",
  "type": "object",
  "required": ["id", "answerFormat", "subject", "topic", "difficulty", "question", "active"],
  "properties": {
    "id": { 
      "type": "string", 
      "pattern": "^[a-z0-9\\-]+$",
      "description": "問題の一意識別子"
    },
    "answerFormat": { 
      "type": "string", 
      "enum": ["A1", "A2", "A3", "F1", "F2"],
      "description": "解答形式 (A1:4択, A2:6択, A3:9択, F1:分数, F2:自由入力)"
    },
    "subject": { 
      "type": "string",
      "description": "科目 (math, english, physics, etc.)"
    },
    "topic": { 
      "type": "string",
      "description": "分野 (algebra, geometry, etc.)"
    },
    "difficulty": { 
      "type": "integer", 
      "minimum": 1, 
      "maximum": 5,
      "description": "難易度 (1:易 - 5:難)"
    },
    "tags": { 
      "type": "array", 
      "items": {"type": "string"},
      "description": "タグ配列"
    },
    "stem": { 
      "type": "string",
      "description": "問題の指示文"
    },
    "question": { 
      "type": "string",
      "description": "問題文"
    },
    "active": { 
      "type": "boolean",
      "description": "問題の有効/無効"
    },
    "explanation": { 
      "type": "string",
      "description": "解説"
    },
    "assets": {
      "type": "object",
      "properties": {
        "image": { "type": ["string", "null"] },
        "audio": { "type": ["string", "null"] }
      },
      "description": "画像・音声などのアセット"
    }
  },
  "allOf": [
    {
      "if": { 
        "properties": { 
          "answerFormat": { "enum": ["A1", "A2", "A3"] } 
        } 
      },
      "then": {
        "required": ["choices", "correctAnswer"],
        "properties": {
          "choices": { 
            "type": "array", 
            "items": {"type": "string"},
            "description": "選択肢配列"
          },
          "correctAnswer": { 
            "type": "integer", 
            "minimum": 0,
            "description": "正解の選択肢インデックス (0から開始)"
          }
        }
      }
    },
    {
      "if": { 
        "properties": { 
          "answerFormat": { "const": "A1" } 
        } 
      },
      "then": {
        "properties": {
          "choices": { "minItems": 4, "maxItems": 4 }
        }
      }
    },
    {
      "if": { 
        "properties": { 
          "answerFormat": { "const": "A2" } 
        } 
      },
      "then": {
        "properties": {
          "choices": { "minItems": 6, "maxItems": 6 }
        }
      }
    },
    {
      "if": { 
        "properties": { 
          "answerFormat": { "const": "A3" } 
        } 
      },
      "then": {
        "properties": {
          "choices": { "minItems": 9, "maxItems": 9 }
        }
      }
    },
    {
      "if": { 
        "properties": { 
          "answerFormat": { "const": "F1" } 
        } 
      },
      "then": {
        "required": ["expectedAnswer"],
        "properties": {
          "expectedAnswer": {
            "type": "object",
            "required": ["a", "b", "c"],
            "properties": {
              "a": { "type": "integer", "description": "分子の係数" },
              "b": { "type": "integer", "minimum": 0, "description": "√の中身" },
              "c": { "type": "integer", "not": {"const": 0}, "description": "分母" }
            },
            "additionalProperties": false,
            "description": "(a+√b)/c 形式の期待値"
          },
          "limits": {
            "type": "object",
            "properties": {
              "a": { 
                "type": "object",
                "properties": {
                  "min": {"type": "integer"},
                  "max": {"type": "integer"}
                }
              },
              "b": { 
                "type": "object",
                "properties": {
                  "min": {"type": "integer", "minimum": 0},
                  "max": {"type": "integer"}
                }
              },
              "c": { 
                "type": "object",
                "properties": {
                  "min": {"type": "integer"},
                  "max": {"type": "integer"}
                }
              }
            },
            "description": "入力値の制限範囲"
          },
          "defaults": {
            "type": "object",
            "properties": {
              "a": {"type": "integer"},
              "b": {"type": "integer"},
              "c": {"type": "integer"}
            },
            "description": "デフォルト値"
          }
        }
      }
    },
    {
      "if": { 
        "properties": { 
          "answerFormat": { "const": "F2" } 
        } 
      },
      "then": {
        "properties": {
          "expectedAnswer": {
            "oneOf": [
              { "type": "string" },
              { 
                "type": "array", 
                "items": {"type": "string"},
                "description": "複数の正解パターン"
              }
            ]
          },
          "defaults": {
            "type": "object",
            "properties": {
              "text": {"type": "string"}
            }
          },
          "validation": {
            "type": "object",
            "properties": {
              "caseSensitive": {"type": "boolean", "default": false},
              "normalizeWhitespace": {"type": "boolean", "default": true},
              "pattern": {"type": "string", "description": "正規表現パターン"}
            }
          }
        }
      }
    }
  ]
}