# allfrom0.top 認証システム クイックスタートガイド

## 概要
このガイドでは、allfrom0.top英語学習サイトに認証システムを導入するためのクイックスタート手順を説明します。

## 前提条件
- Cloudflareアカウント
- allfrom0.topドメインの管理権限
- Node.js (v18以上)
- Wrangler CLI

## ステップ1: 環境準備

### 1.1 必要なツールのインストール
```bash
# Wrangler CLIのインストール
npm install -g wrangler

# Cloudflareへのログイン
wrangler login
```

### 1.2 プロジェクトのセットアップ
```bash
# プロジェクトディレクトリの作成
mkdir allfrom0-auth
cd allfrom0-auth

# Gitリポジトリの初期化
git init
```

## ステップ2: Cloudflareリソースの作成

### 2.1 D1データベースの作成
```bash
# データベース作成
wrangler d1 create allfrom0-db

# 出力されたdatabase_idをwrangler.tomlに設定
```

### 2.2 KVネームスペースの作成
```bash
# セッション用KV
wrangler kv namespace create allfrom0-sessions

# 出力されたnamespace_idをwrangler.tomlに設定
```

## ステップ3: 基本ファイルの作成

### 3.1 wrangler.toml
```toml
name = "allfrom0-auth"
main = "src/index.js"
compatibility_date = "2024-01-01"

[[d1_databases]]
binding = "DB"
database_name = "allfrom0-db"
database_id = "your-database-id-here"

[[kv_namespaces]]
binding = "SESSIONS"
namespace_id = "your-kv-namespace-id-here"

[env.production]
vars = { ENVIRONMENT = "production" }
```

### 3.2 package.json
```json
{
  "name": "allfrom0-auth",
  "version": "1.0.0",
  "scripts": {
    "dev": "wrangler dev",
    "deploy": "wrangler deploy"
  },
  "devDependencies": {
    "wrangler": "^3.0.0"
  }
}
```

## ステップ4: データベーススキーマの作成

### 4.1 schema.sql
```sql
-- ユーザーテーブル
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT UNIQUE NOT NULL,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    display_name TEXT,
    avatar_url TEXT,
    english_level TEXT DEFAULT 'beginner',
    created_at TEXT DEFAULT (datetime('now')),
    last_login TEXT,
    login_count INTEGER DEFAULT 0
);

-- 英語学習進捗テーブル
CREATE TABLE english_progress (
    user_id INTEGER,
    skill_type TEXT,
    level INTEGER DEFAULT 1,
    xp INTEGER DEFAULT 0,
    lessons_completed INTEGER DEFAULT 0,
    accuracy_rate REAL DEFAULT 0.0,
    streak_days INTEGER DEFAULT 0,
    last_practice TEXT DEFAULT (datetime('now')),
    PRIMARY KEY (user_id, skill_type),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 学習セッション履歴
CREATE TABLE study_sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    skill_type TEXT,
    lesson_id TEXT,
    score INTEGER,
    time_spent INTEGER,
    completed_at TEXT DEFAULT (datetime('now')),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## ステップ5: Workerコードの実装

### 5.1 src/index.js
```javascript
import { AuthHandler } from './auth.js';

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const path = url.pathname;
    
    // CORS設定
    const corsHeaders = {
      'Access-Control-Allow-Origin': 'https://allfrom0.top',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    };
    
    // プレフライトリクエスト処理
    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: corsHeaders });
    }
    
    // 認証ハンドラー
    const authHandler = new AuthHandler(env);
    
    // ルーティング
    if (path.startsWith('/api/auth/')) {
      const response = await authHandler.handleAuth(request);
      return new Response(response.body, {
        status: response.status,
        headers: { ...corsHeaders, ...response.headers }
      });
    }
    
    if (path.startsWith('/api/english/')) {
      const response = await authHandler.handleEnglishProgress(request);
      return new Response(response.body, {
        status: response.status,
        headers: { ...corsHeaders, ...response.headers }
      });
    }
    
    return new Response('Not Found', { status: 404 });
  }
};
```

### 5.2 src/auth.js
```javascript
import * as bcrypt from 'bcrypt';
import { v4 as uuidv4 } from 'uuid';

export class AuthHandler {
  constructor(env) {
    this.env = env;
  }
  
  async handleAuth(request) {
    const url = new URL(request.url);
    const path = url.pathname;
    
    switch (path) {
      case '/api/auth/register':
        return this.register(request);
      case '/api/auth/login':
        return this.login(request);
      case '/api/auth/logout':
        return this.logout(request);
      case '/api/auth/me':
        return this.getMe(request);
      default:
        return this.notFound();
    }
  }
  
  async register(request) {
    try {
      const { email, username, password } = await request.json();
      
      // 入力検証
      if (!email || !username || !password) {
        return this.error('必須項目を入力してください', 400);
      }
      
      // パスワードハッシュ化
      const passwordHash = await bcrypt.hash(password, 10);
      
      // ユーザー作成
      const result = await this.env.DB.prepare(`
        INSERT INTO users (email, username, password_hash)
        VALUES (?, ?, ?)
      `).bind(email, username, passwordHash).run();
      
      return this.success({ 
        message: 'ユーザー登録が完了しました',
        userId: result.meta.last_row_id
      });
      
    } catch (error) {
      return this.error('登録に失敗しました', 500);
    }
  }
  
  async login(request) {
    try {
      const { email, password } = await request.json();
      
      // ユーザー検索
      const user = await this.env.DB.prepare(`
        SELECT * FROM users WHERE email = ?
      `).bind(email).first();
      
      if (!user) {
        return this.error('メールアドレスまたはパスワードが違います', 401);
      }
      
      // パスワード検証
      const isValid = await bcrypt.compare(password, user.password_hash);
      if (!isValid) {
        return this.error('メールアドレスまたはパスワードが違います', 401);
      }
      
      // セッション作成
      const sessionId = uuidv4();
      const sessionData = {
        userId: user.id,
        email: user.email,
        username: user.username,
        createdAt: Date.now()
      };
      
      await this.env.SESSIONS.put(sessionId, JSON.stringify(sessionData), {
        expirationTtl: 24 * 60 * 60 // 24時間
      });
      
      // ログイン情報更新
      await this.env.DB.prepare(`
        UPDATE users SET last_login = ?, login_count = login_count + 1
        WHERE id = ?
      `).bind(new Date().toISOString(), user.id).run();
      
      return this.success({
        token: sessionId,
        user: {
          id: user.id,
          email: user.email,
          username: user.username,
          displayName: user.display_name
        }
      });
      
    } catch (error) {
      return this.error('ログインに失敗しました', 500);
    }
  }
  
  async logout(request) {
    try {
      const authHeader = request.headers.get('Authorization');
      if (!authHeader) {
        return this.error('認証トークンが必要です', 401);
      }
      
      const token = authHeader.replace('Bearer ', '');
      await this.env.SESSIONS.delete(token);
      
      return this.success({ message: 'ログアウトしました' });
    } catch (error) {
      return this.error('ログアウトに失敗しました', 500);
    }
  }
  
  async getMe(request) {
    try {
      const user = await this.authenticate(request);
      if (!user) {
        return this.error('認証に失敗しました', 401);
      }
      
      return this.success(user);
    } catch (error) {
      return this.error('ユーザー情報の取得に失敗しました', 500);
    }
  }
  
  async authenticate(request) {
    const authHeader = request.headers.get('Authorization');
    if (!authHeader) {
      return null;
    }
    
    const token = authHeader.replace('Bearer ', '');
    const sessionData = await this.env.SESSIONS.get(token);
    
    if (!sessionData) {
      return null;
    }
    
    return JSON.parse(sessionData);
  }
  
  success(data, status = 200) {
    return {
      status,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ success: true, ...data })
    };
  }
  
  error(message, status = 400) {
    return {
      status,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ success: false, error: message })
    };
  }
  
  notFound() {
    return this.error('Not Found', 404);
  }
}
```

## ステップ6: デプロイ

### 6.1 データベーススキーマの適用
```bash
# スキーマの適用
wrangler d1 execute allfrom0-db --file=schema.sql
```

### 6.2 Workerのデプロイ
```bash
# デプロイ
wrangler deploy
```

### 6.3 カスタムドメインの設定
1. Cloudflareダッシュボードで`api.allfrom0.top`のDNS設定
2. CNAMEレコードをWorkerのURLに設定
3. Workerルートで`api.allfrom0.top/*`を設定

## ステップ7: フロントエンドの統合

### 7.1 認証JavaScriptの作成
```javascript
// auth-allfrom0.js
class AllFrom0Auth {
  constructor() {
    this.apiBase = 'https://api.allfrom0.top/api';
    this.token = localStorage.getItem('allfrom0_auth_token');
    this.user = JSON.parse(localStorage.getItem('allfrom0_user_data') || 'null');
    this.init();
  }
  
  init() {
    if (this.token) {
      this.validateToken();
    }
    this.setupEventListeners();
  }
  
  setupEventListeners() {
    // ログインフォーム
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.login(
          document.getElementById('loginEmail').value,
          document.getElementById('loginPassword').value
        );
      });
    }
    
    // 登録フォーム
    const registerForm = document.getElementById('registerForm');
    if (registerForm) {
      registerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.register(
          document.getElementById('registerEmail').value,
          document.getElementById('registerUsername').value,
          document.getElementById('registerPassword').value
        );
      });
    }
  }
  
  async login(email, password) {
    try {
      const response = await fetch(`${this.apiBase}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      
      const data = await response.json();
      
      if (data.success) {
        this.token = data.token;
        this.user = data.user;
        localStorage.setItem('allfrom0_auth_token', this.token);
        localStorage.setItem('allfrom0_user_data', JSON.stringify(this.user));
        this.updateUI();
        this.showSuccess('ログインしました');
      } else {
        this.showError(data.error);
      }
    } catch (error) {
      this.showError('ネットワークエラーが発生しました');
    }
  }
  
  async register(email, username, password) {
    try {
      const response = await fetch(`${this.apiBase}/auth/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, username, password })
      });
      
      const data = await response.json();
      
      if (data.success) {
        this.showSuccess('登録が完了しました');
        this.switchToLogin();
      } else {
        this.showError(data.error);
      }
    } catch (error) {
      this.showError('ネットワークエラーが発生しました');
    }
  }
  
  updateUI() {
    const loginBtn = document.getElementById('loginBtn');
    const userMenu = document.getElementById('userMenu');
    
    if (this.user) {
      loginBtn.style.display = 'none';
      userMenu.style.display = 'flex';
      document.getElementById('userName').textContent = this.user.displayName || this.user.username;
    } else {
      loginBtn.style.display = 'block';
      userMenu.style.display = 'none';
    }
  }
  
  showSuccess(message) {
    // 成功メッセージ表示
    const toast = document.createElement('div');
    toast.className = 'toast success';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
  
  showError(message) {
    // エラーメッセージ表示
    const toast = document.createElement('div');
    toast.className = 'toast error';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
}

// 初期化
const auth = new AllFrom0Auth();
```

### 7.2 HTMLへの統合
```html
<!-- 既存のHTMLに認証UIを追加 -->
<div id="authModal" class="auth-modal" style="display: none;">
  <div class="auth-container">
    <div class="auth-tabs">
      <button class="auth-tab active" data-tab="login">ログイン</button>
      <button class="auth-tab" data-tab="register">新規登録</button>
    </div>
    
    <form id="loginForm" class="auth-form">
      <h2>ログイン</h2>
      <input type="email" id="loginEmail" placeholder="メールアドレス" required>
      <input type="password" id="loginPassword" placeholder="パスワード" required>
      <button type="submit" class="btn primary">ログイン</button>
    </form>
    
    <form id="registerForm" class="auth-form" style="display: none;">
      <h2>新規登録</h2>
      <input type="email" id="registerEmail" placeholder="メールアドレス" required>
      <input type="text" id="registerUsername" placeholder="ユーザー名" required>
      <input type="password" id="registerPassword" placeholder="パスワード (8文字以上)" required>
      <button type="submit" class="btn primary">登録</button>
    </form>
  </div>
</div>

<!-- JavaScriptの読み込み -->
<script src="auth-allfrom0.js"></script>
```

## ステップ8: テスト

### 8.1 APIテスト
```bash
# ヘルスチェック
curl https://api.allfrom0.top/api/health

# ユーザー登録テスト
curl -X POST https://api.allfrom0.top/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@allfrom0.top","username":"testuser","password":"testpass123"}'

# ログインテスト
curl -X POST https://api.allfrom0.top/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@allfrom0.top","password":"testpass123"}'
```

### 8.2 フロントエンドテスト
1. ユーザー登録機能のテスト
2. ログイン機能のテスト
3. ログアウト機能のテスト
4. セッションタイムアウトのテスト

## トラブルシューティング

### 一般的な問題
1. **CORSエラー**: CloudflareダッシュボードでCORS設定を確認
2. **データベース接続エラー**: D1バインディング設定を確認
3. **KV接続エラー**: KVネームスペース設定を確認
4. **デプロイエラー**: Wranglerのバージョンを確認

### デバッグ方法
```bash
# ローカルでテスト
wrangler dev

# ログの確認
wrangler tail

# データベースの確認
wrangler d1 execute allfrom0-db --command="SELECT * FROM users"
```

## 次のステップ
1. 学習進捗機能の実装
2. パスワードリセット機能の追加
3. ソーシャルログインの実装
4. 管理者ダッシュボードの作成

---

このクイックスタートガイドに従って、allfrom0.top英語学習サイトに認証システムを導入してください。質問がある場合は、各ステップの詳細なドキュメントを参照するか、サポートに連絡してください。