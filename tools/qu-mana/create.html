<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>問題作成 - 問題管理システム</title>
    <meta name="description" content="新しい問題を作成">
    <link rel="stylesheet" href="css/style.css">
    <script src="data/config.js"></script>
    <script src="data/question-types.js"></script>
    <script src="data/sample-data.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="header-title">問題作成</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary btn-sm" onclick="goBack()">
                        ← 戻る
                    </button>
                </div>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="container">
            <a href="index.html" class="nav-item">📊 ダッシュボード</a>
            <a href="create.html" class="nav-item active">➕ 作成</a>
            <a href="list.html" class="nav-item">📋 一覧</a>
            <a href="stats.html" class="nav-item">📈 統計</a>
        </div>
    </nav>

    <main class="container">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">新しい問題を作成</h2>
            </div>
            <div class="card-body">
                <form id="question-form">
                    <!-- 問題タイプ選択 -->
                    <div class="form-group">
                        <label class="form-label">問題タイプ</label>
                        <select id="question-type" class="form-select" onchange="updateFormFields()" required>
                            <option value="">選択してください</option>
                        </select>
                    </div>

                    <!-- 難易度 -->
                    <div class="form-group">
                        <label class="form-label">難易度</label>
                        <select id="difficulty" class="form-select" required>
                            <option value="1">初級</option>
                            <option value="2">中級</option>
                            <option value="3">上級</option>
                            <option value="4">最上級</option>
                        </select>
                    </div>

                    <!-- タグ -->
                    <div class="form-group">
                        <label class="form-label">タグ</label>
                        <input type="text" id="tags" class="form-input" placeholder="カンマ区切りで入力">
                        <div class="form-help">例: 語彙,文法,初級</div>
                    </div>

                    <!-- 動的フォームフィールド -->
                    <div id="dynamic-fields">
                        <!-- 問題タイプに応じて動的に生成 -->
                    </div>

                    <!-- ボタン -->
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block">
                            💾 保存
                        </button>
                        <button type="button" class="btn btn-secondary btn-block" onclick="previewQuestion()">
                            👁️ プレビュー
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- プレビューセクション -->
        <div id="preview-section" class="card" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">プレビュー</h2>
            </div>
            <div class="card-body">
                <div id="preview-content">
                    <!-- プレビュー内容を動的に生成 -->
                </div>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        // ページ初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
        });

        function initializeForm() {
            // 問題タイプ選択肢を生成
            const typeSelect = document.getElementById('question-type');
            Object.keys(window.QUESTION_TYPES).forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = window.QUESTION_TYPES[type].name;
                typeSelect.appendChild(option);
            });

            // URLパラメータから問題タイプを取得
            const urlParams = new URLSearchParams(window.location.search);
            const type = urlParams.get('type');
            if (type && window.QUESTION_TYPES[type]) {
                typeSelect.value = type;
                updateFormFields();
            }
        }

        function updateFormFields() {
            const type = document.getElementById('question-type').value;
            const container = document.getElementById('dynamic-fields');
            
            container.innerHTML = '';
            
            if (!type || !window.QUESTION_TYPES[type]) {
                return;
            }

            const questionType = window.QUESTION_TYPES[type];
            
            questionType.fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const label = document.createElement('label');
                label.className = 'form-label';
                label.textContent = field.label;
                if (field.required) {
                    label.textContent += ' *';
                }
                
                let input;
                if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.className = 'form-textarea';
                    input.rows = 4;
                } else if (field.type === 'array') {
                    input = document.createElement('textarea');
                    input.className = 'form-textarea';
                    input.placeholder = '1行に1つずつ入力してください';
                } else {
                    input = document.createElement('input');
                    input.type = field.type;
                    input.className = 'form-input';
                }
                
                input.id = field.name;
                input.name = field.name;
                if (field.required) {
                    input.required = true;
                }
                if (field.default) {
                    input.value = field.default;
                }
                
                formGroup.appendChild(label);
                formGroup.appendChild(input);
                
                if (field.help) {
                    const help = document.createElement('div');
                    help.className = 'form-help';
                    help.textContent = field.help;
                    formGroup.appendChild(help);
                }
                
                container.appendChild(formGroup);
            });
        }

        function previewQuestion() {
            const formData = collectFormData();
            if (!formData) {
                alert('フォームに必須項目を入力してください');
                return;
            }

            const previewSection = document.getElementById('preview-section');
            const previewContent = document.getElementById('preview-content');
            
            // プレビューHTMLを生成
            let previewHtml = generatePreviewHtml(formData);
            previewContent.innerHTML = previewHtml;
            previewSection.style.display = 'block';
            
            // プレビューセクションにスクロール
            previewSection.scrollIntoView({ behavior: 'smooth' });
        }

        function collectFormData() {
            const type = document.getElementById('question-type').value;
            const difficulty = document.getElementById('difficulty').value;
            const tags = document.getElementById('tags').value;
            
            if (!type) {
                return null;
            }

            const questionType = window.QUESTION_TYPES[type];
            const data = {
                type: type,
                difficulty: parseInt(difficulty),
                tags: tags ? tags.split(',').map(t => t.trim()) : []
            };

            // 動的フィールドからデータを収集
            questionType.fields.forEach(field => {
                const input = document.getElementById(field.name);
                if (input) {
                    if (field.type === 'array') {
                        data[field.name] = input.value.split('\n').filter(line => line.trim());
                    } else {
                        data[field.name] = input.value;
                    }
                }
            });

            return data;
        }

        function generatePreviewHtml(data) {
            const questionType = window.QUESTION_TYPES[data.type];
            let html = `<div class="preview-question">`;
            html += `<h3>${questionType.name}</h3>`;
            html += `<p><strong>難易度:</strong> ${window.CONFIG.DIFFICULTY_LEVELS[data.difficulty]}</p>`;
            
            if (data.tags.length > 0) {
                html += `<p><strong>タグ:</strong> ${data.tags.map(tag => `<span class="badge badge-secondary">${tag}</span>`).join(' ')}</p>`;
            }

            // 問題タイプに応じたプレビュー
            switch (data.type) {
                case 'vocab_meaning':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>単語:</strong> ${data.word}</p>`;
                    html += `<div class="options">`;
                    data.options.forEach((option, index) => {
                        html += `<div class="option">${index + 1}. ${option}</div>`;
                    });
                    html += `</div>`;
                    html += `<p><strong>正解:</strong> ${data.correct}</p>`;
                    html += `</div>`;
                    break;
                    
                case 'vocab_fill':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>英文:</strong> ${data.sentence.replace('_____', `<u>${data.blank_word}</u>`)}</p>`;
                    html += `<div class="options">`;
                    data.options.forEach((option, index) => {
                        html += `<div class="option">${index + 1}. ${option}</div>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                    break;
                    
                case 'grammar_reorder':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>単語:</strong> ${data.scrambled_words.join(', ')}</p>`;
                    html += `<p><strong>正解:</strong> ${data.correct_order.join(' ')}</p>`;
                    html += `</div>`;
                    break;
                    
                case 'reading_comprehension':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>本文:</strong></p>`;
                    html += `<div class="passage">${data.passage}</div>`;
                    html += `<p><strong>設問数:</strong> ${data.questions.length}</p>`;
                    html += `</div>`;
                    break;
                    
                case 'summary_short':
                case 'summary_medium':
                case 'summary_long':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>本文:</strong></p>`;
                    html += `<div class="passage">${data.passage}</div>`;
                    html += `<p><strong>目標字数:</strong> ${data.target_length}字</p>`;
                    if (data.sample_answer) {
                        html += `<p><strong>模範解答:</strong> ${data.sample_answer}</p>`;
                    }
                    html += `</div>`;
                    break;
                    
                default:
                    html += `<p>この問題タイプのプレビューはまだ実装されていません</p>`;
            }
            
            html += `</div>`;
            return html;
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        // フォーム送信
        document.getElementById('question-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = collectFormData();
            if (!formData) {
                alert('フォームに必須項目を入力してください');
                return;
            }

            if (window.app) {
                try {
                    const question = window.app.createQuestion(formData.type, formData);
                    window.app.showNotification('問題を作成しました', 'success');
                    
                    // 確認ダイアログ
                    if (confirm('問題を作成しました。続けて作成しますか？')) {
                        // フォームをリセット
                        document.getElementById('question-form').reset();
                        document.getElementById('dynamic-fields').innerHTML = '';
                        document.getElementById('preview-section').style.display = 'none';
                    } else {
                        // ダッシュボードに戻る
                        window.location.href = 'index.html';
                    }
                } catch (error) {
                    window.app.showNotification('問題の作成に失敗しました', 'error');
                    console.error('Create question failed:', error);
                }
            } else {
                alert('アプリケーションが初期化されていません');
            }
        });
    </script>
</body>
</html>