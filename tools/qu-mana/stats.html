<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>統計 - 問題管理システム</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="data/config.js"></script>
    <script src="data/question-types.js"></script>
    <script src="data/sample-data.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="header-title">統計</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary btn-sm" onclick="exportStatistics()">
                        📤 エクスポート
                    </button>
                </div>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="container">
            <a href="index.html" class="nav-item">📊 ダッシュボード</a>
            <a href="create.html" class="nav-item">➕ 作成</a>
            <a href="list.html" class="nav-item">📋 一覧</a>
            <a href="stats.html" class="nav-item active">📈 統計</a>
        </div>
    </nav>

    <main class="container">
        <!-- 概要統計 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-questions">0</div>
                <div class="stat-label">総問題数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="published-questions">0</div>
                <div class="stat-label">公開済み</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="draft-questions">0</div>
                <div class="stat-label">下書き</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="deleted-questions">0</div>
                <div class="stat-label">削除済み</div>
            </div>
        </div>

        <!-- 問題タイプ別統計 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">問題タイプ別統計</h2>
            </div>
            <div class="card-body">
                <div id="type-stats">
                    <!-- 動的に生成 -->
                </div>
            </div>
        </div>

        <!-- 難易度別統計 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">難易度別統計</h2>
            </div>
            <div class="card-body">
                <div id="difficulty-stats">
                    <!-- 動的に生成 -->
                </div>
            </div>
        </div>

        <!-- 最近の活動 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">最近の活動</h2>
            </div>
            <div class="card-body">
                <div id="recent-activity">
                    <!-- 動的に生成 -->
                </div>
            </div>
        </div>

        <!-- タグ統計 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">タグ統計</h2>
            </div>
            <div class="card-body">
                <div id="tag-stats">
                    <!-- 動的に生成 -->
                </div>
            </div>
        </div>

        <!-- 月別統計 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">月別統計</h2>
            </div>
            <div class="card-body">
                <div id="monthly-stats">
                    <!-- 動的に生成 -->
                </div>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        // ページ初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeStats();
            
            // 定期的に更新
            setInterval(() => {
                if (window.app) {
                    updateStatistics();
                }
            }, 5000);
        });

        function initializeStats() {
            setTimeout(() => {
                if (window.app) {
                    updateStatistics();
                }
            }, 1000);
        }

        function updateStatistics() {
            if (!window.app) return;

            const stats = window.app.statistics;
            
            // 概要統計の更新
            document.getElementById('total-questions').textContent = stats.totalQuestions || 0;
            document.getElementById('published-questions').textContent = stats.questionsByStatus.published || 0;
            document.getElementById('draft-questions').textContent = stats.questionsByStatus.draft || 0;
            document.getElementById('deleted-questions').textContent = stats.questionsByStatus.deleted || 0;
            
            // 問題タイプ別統計
            updateTypeStats();
            
            // 難易度別統計
            updateDifficultyStats();
            
            // 最近の活動
            updateRecentActivity();
            
            // タグ統計
            updateTagStats();
            
            // 月別統計
            updateMonthlyStats();
        }

        function updateTypeStats() {
            const container = document.getElementById('type-stats');
            const stats = window.app.statistics.questionsByType;
            
            let html = '<div class="stats-grid">';
            Object.keys(stats).forEach(type => {
                const count = stats[type];
                const typeInfo = window.QUESTION_TYPES[type];
                if (typeInfo) {
                    html += `
                        <div class="stat-card">
                            <div class="stat-number">${count}</div>
                            <div class="stat-label">${typeInfo.name}</div>
                        </div>
                    `;
                }
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function updateDifficultyStats() {
            const container = document.getElementById('difficulty-stats');
            const stats = window.app.statistics.questionsByDifficulty;
            
            let html = '<div class="stats-grid">';
            Object.keys(stats).forEach(difficulty => {
                const count = stats[difficulty];
                html += `
                    <div class="stat-card">
                        <div class="stat-number">${count}</div>
                        <div class="stat-label">${window.CONFIG.DIFFICULTY_LEVELS[difficulty]}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function updateRecentActivity() {
            const container = document.getElementById('recent-activity');
            const activities = window.app.statistics.recentActivity || [];
            
            let html = '<div class="activity-list">';
            activities.slice(0, 10).forEach(activity => {
                const date = new Date(activity.timestamp);
                const dateStr = date.toLocaleDateString('ja-JP');
                const timeStr = date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                
                const actionLabels = {
                    create: '作成',
                    update: '更新',
                    delete: '削除',
                    publish: '公開'
                };
                
                html += `
                    <div class="list-item">
                        <div>
                            <div class="text-primary">${actionLabels[activity.action] || activity.action}</div>
                            <div class="text-muted">${activity.type} - ${dateStr} ${timeStr}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html || '<p class="text-muted">最近の活動はありません</p>';
        }

        function updateTagStats() {
            const container = document.getElementById('tag-stats');
            const allTags = {};
            
            // 全てのタグを収集
            Object.keys(window.app.questions).forEach(type => {
                window.app.questions[type].forEach(question => {
                    if (question.tags) {
                        question.tags.forEach(tag => {
                            allTags[tag] = (allTags[tag] || 0) + 1;
                        });
                    }
                });
            });
            
            // 使用頻度でソート
            const sortedTags = Object.entries(allTags)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);
            
            let html = '<div class="tag-cloud">';
            sortedTags.forEach(([tag, count]) => {
                const size = Math.max(0.8, Math.min(1.5, count / 5));
                html += `<span class="tag-item" style="font-size: ${size}em;">${tag} (${count})</span>`;
            });
            html += '</div>';
            
            container.innerHTML = html || '<p class="text-muted">タグはありません</p>';
        }

        function updateMonthlyStats() {
            const container = document.getElementById('monthly-stats');
            const monthlyStats = {};
            
            // 月別統計を計算
            Object.keys(window.app.questions).forEach(type => {
                window.app.questions[type].forEach(question => {
                    const date = new Date(question.created);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyStats[monthKey]) {
                        monthlyStats[monthKey] = {
                            created: 0,
                            published: 0,
                            drafts: 0
                        };
                    }
                    
                    monthlyStats[monthKey].created++;
                    if (question.status === 'published') {
                        monthlyStats[monthKey].published++;
                    } else if (question.status === 'draft') {
                        monthlyStats[monthKey].drafts++;
                    }
                });
            });
            
            // 月でソート
            const sortedMonths = Object.keys(monthlyStats).sort().reverse();
            
            let html = '<div class="monthly-stats">';
            sortedMonths.slice(0, 6).forEach(month => {
                const stats = monthlyStats[month];
                html += `
                    <div class="list-item">
                        <div>
                            <div class="text-primary">${month}</div>
                            <div class="text-muted">
                                作成: ${stats.created} | 
                                公開: ${stats.published} | 
                                下書き: ${stats.drafts}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html || '<p class="text-muted">月別統計はありません</p>';
        }

        function exportStatistics() {
            if (!window.app) return;
            
            try {
                const stats = window.app.statistics;
                const exportData = {
                    statistics: stats,
                    questions: window.app.questions,
                    exported: new Date().toISOString(),
                    version: window.app.config.VERSION
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `statistics_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                window.app.showNotification('統計データをエクスポートしました', 'success');
            } catch (error) {
                window.app.showNotification('エクスポートに失敗しました', 'error');
            }
        }
    </script>
</body>
</html>